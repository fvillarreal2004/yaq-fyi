<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>yaq protocol</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>

<h1>yaq communication protocol</h1>

<hr>

.TH yaqd 7 2019-06-25 0.1.0
.SH NAME
yaqd - Daemon infrastructure for the yaq system
.SH COMMUNICATION PROTOCOL

.PP
.B yaq daemons
MUST communicate over
.B tcp(7)
ports.
By convention, daemons SHOULD serve on ports in the range 36000-39999.
This range avoids most collisions with common TCP port usage in other applications.
Users MAY use ports outside of this range, however tools like
.B yaqd-list-daemons(1)
will not check ports other than this range by default.

.PP
TCP was chosen to maximize cross system and cross language compatibility.
Future versions of this specification may allow for other
.B socket(7)
implementations as alternatives to
.B tcp(7)
at the users option.

.SH REQUEST CONTENT
.PP
The request takes the form of a JSON-RPC v2.0 (https://www.jsonrpc.org/specification) request object.
All standard JSON data types (Number, String, Boolean, Array, Object, null)
are supported.
In addition, the non-standard values "Infinity" "-Infinity" and "NaN" are allowed.
These are considered floating point numbers.
Many JSON encoders/decoders support these values by default or with a simple flag.
Strings are
.B utf-8(7)
encoded.

.PP
Future versions of this standard may specify additional data types not in the JSON standard.

.SH RESPONSE CONTENT
The daemon's response MUST use the same JSON serialization as the request.
The response object is complient with JSON-RPC v2.0

.SH ENTRY POINT

The standard entry point to initiate a daemon SHALL be
.B yaqd-
.I <kind>
where
.I <kind>
is a lowercase name for the daemon with words separated by hyphens.

Examples of valid entry points include
.B yaqd-base-hardware ,
.B yaqd-micro-hr ,
and
.B yaqd-zaber-binary .

The entry point SHALL accept the option --config <filepath> and the short form -c of this option.



.SH CONFIGURATION

The default configuration file location SHALL be:

.B macOS\t
"~/Library/Application Support/yaqd/<kind>/config.toml"

.B XDG Spec (e.g. Linux)\t
"~/.config/yaqd/<kind>/config.toml"

.B Windows\t
"C:\\Documents and Settings\\<User>\\Application Data\\Local Settings\\yaq\\yaqd\\<kind>\\config.toml"

Where
.I <kind>
is the same as in the ENTRY POINT section.

Configuration is in TOML (https://github.com/toml-lang/toml).
Any valid TOML types MAY be used.

Top level keys are used for

.B entry\t
.I recommended\t
.B string

The entry point associated with this configuration.
Used by
.B yaqd-start-daemons(1)
to start daemons with the configuration


.B enable\t
.I optional\t
.B boolean

If given and set to false, the daemon MUST exit immediately without opening TCP ports.
If not given, true is assumed.

.B shared-settings\t
.I optional\t
.B table

If present, provides defaults that apply to all other tables.
These defaults MAY be overridden by the other tables for the individual port.

Every other top-level key MUST be a table, for which the name indicates the name of the daemon
which MUST be exposed on the given port.
These names MUST be unique at the level of
.I <kind>.

Each table MUST include a key "port" which provides the globally-unique (among all daemons) TCP port.
Additional fields MAY be added, as needed for configuring the daemon.
Specific implementations MAY have additional required configuration parameters.
Fields MAY be included that are only used by the clients, and retrieved by
.B get_config
(see below).

ALL tables other than those that are disabled, and
.B shared-settings
MUST be started when invoking a daemon entry point with the config file.
They MAY (and in many cases must for technical reasons) be starting several daemons listening in the same process.


The configuration file MUST NOT be written by the daemon.
Any runtime dynamic fields SHOULD be written in the state file (see below) and have ways of detecting and/or expose setting over the TCP communication protocol described above.

Additional identifying information SHOULD be included, as applicable.
Common identifying information include:
.B make
(manufacturer),
.B model
(identifies the kind as described by the manufacturer),
.B serial
(individual serial number of the device represented),
.B units
(units for numbers interpreted and sent).
This limited subset (along with the <name> as defined by the table name and the <kind> as defined by the implementation) are returned by the
.B id
method (see below).


The configuration file MUST be read from the file at daemon startup ONLY (restarting is considered "startup", and MUST re-read the configuration file in case changes were made).


.SH STATE SAVING

Dynamic fields are saved to a similar TOML file.
Included fields SHOULD be of potential value to clients or needed across restarts of the daemon.

EACH daemon MUST SAVE a file at (unless that file is empty, in which case it MAY be omitted):

.B macOS\t
"~/Library/Application Support/yaqd-state/<kind>/<name>-state.toml"

.B XDG Spec (e.g. Linux)\t
"~/.local/share/yaqd-state/<kind>/<name>-state.toml"

.B Windows\t
"C:\\Documents and Settings\\<User>\\Application Data\\Local Settings\\yaq\\yaqd-state\\<kind>\\<name>-state.toml"

By default, there are no required keys in the state.
The content saved MUST be the same as returned by the
.B get_state
method (see below).

If possible, recorded state SHOULD fully describe the hardware such that recovery from a shutdown (including unepected shutdown) will be seamless without any additional user input.


.SH STANDARD COMMANDS
.B id
.PP
JSON object with information to identify the daemon, including
.B name,
.B kind,
.B make,
.B model,
.B serial,
.B units.

.B config_filepath
.PP
String representing the absolute filepath of the configuration file on the host machine.

.B get_config
.PP
JSON object with the full configuration for the individual daemon as defined in the TOML file.
This includes defaults and shared settings not directly specified in the daemon-specific TOML table.

.B get_state
.PP
JSON object representing the current state, as saved in the <name>-state.toml file.

.B list_methods
.PP
Array of the (string) names of all known (public) methods.

.BI help( method= None "" )
.PP
If method not given, return a human-readable string with information about the daemon as a whole.
If method is given, return a human-readable string with the signature of the method on the first line and a description of the method on subsequent lines.
The signature is not specified to be in any particular language.
It is intended for usage by humans ONLY.

</body>
</html>
